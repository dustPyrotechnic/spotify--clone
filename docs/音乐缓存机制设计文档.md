# Spotify Clone éŸ³ä¹ç¼“å­˜æœºåˆ¶è®¾è®¡æ–‡æ¡£

> æ–‡æ¡£ç‰ˆæœ¬ï¼š1.0  
> æ›´æ–°æ—¥æœŸï¼š2026-02-07  
> ä½œè€…ï¼šAI Assistant

---

## ä¸€ã€æ¦‚è¿°

### 1.1 è®¾è®¡ç›®æ ‡

æœ¬éŸ³ä¹æ’­æ”¾å™¨é‡‡ç”¨**å¤šçº§ç¼“å­˜ç­–ç•¥**ï¼Œæ—¨åœ¨ï¼š

1. **æå‡æ’­æ”¾æµç•…åº¦** - å‡å°‘ç½‘ç»œç­‰å¾…æ—¶é—´ï¼Œå®ç°ç§’å¼€æ’­æ”¾
2. **èŠ‚çœæµé‡** - é¿å…é‡å¤ä¸‹è½½åŒä¸€é¦–æ­Œæ›²
3. **ä¼˜åŒ–å†…å­˜ä½¿ç”¨** - æ™ºèƒ½ç®¡ç†å†…å­˜ï¼Œé˜²æ­¢ OOM
4. **æ”¯æŒç¦»çº¿æ’­æ”¾** - å·²ç¼“å­˜æ­Œæ›²å¯åœ¨æ— ç½‘ç»œæ—¶æ’­æ”¾

### 1.2 ç¼“å­˜å±‚çº§æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç”¨æˆ·ç‚¹å‡»æ’­æ”¾                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Level 1: å†…å­˜ç¼“å­˜ (NSCache)                                 â”‚
â”‚  â”œâ”€ æŸ¥è¯¢ NSCache ä¸­æ˜¯å¦æœ‰éŸ³é¢‘æ•°æ®                             â”‚
â”‚  â”œâ”€ å‘½ä¸­ â†’ ç›´æ¥è¯»å–å†…å­˜æ•°æ®å†™å…¥ä¸´æ—¶æ–‡ä»¶ â†’ æ’­æ”¾                 â”‚
â”‚  â””â”€ æœªå‘½ä¸­ â†’ è¿›å…¥ Level 2                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Level 2: ä¸´æ—¶æ–‡ä»¶ç¼“å­˜                                        â”‚
â”‚  â”œâ”€ æŸ¥è¯¢ /tmp/MusicCache/ ç›®å½•ä¸‹æ˜¯å¦æœ‰ .mp3 æ–‡ä»¶              â”‚
â”‚  â”œâ”€ å‘½ä¸­ â†’ ç›´æ¥è¿”å›æ–‡ä»¶ URL â†’ æ’­æ”¾                           â”‚
â”‚  â””â”€ æœªå‘½ä¸­ â†’ è¿›å…¥ Level 3ï¼ˆç½‘ç»œä¸‹è½½ï¼‰                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Level 3: ç½‘ç»œä¸‹è½½ + è¾¹ä¸‹è¾¹æ’­                                  â”‚
â”‚  â”œâ”€ è°ƒç”¨ findUrlOfSongWithId: è·å–æ­Œæ›²çœŸå® URL               â”‚
â”‚  â”œâ”€ AVPlayer å¼€å§‹è¾¹ä¸‹è¾¹æ’­                                    â”‚
â”‚  â””â”€ åå°å¹¶å‘ä¸‹è½½å®Œæ•´éŸ³é¢‘åˆ°å†…å­˜ç¼“å­˜ï¼ˆä¾›ä¸‹æ¬¡ä½¿ç”¨ï¼‰                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€æ ¸å¿ƒç»„ä»¶

### 2.1 XCMusicMemoryCacheï¼ˆå†…å­˜ç¼“å­˜ç®¡ç†å™¨ï¼‰

**å•ä¾‹æ¨¡å¼å®ç°**ï¼Œè´Ÿè´£ç®¡ç†å†…å­˜ä¸­çš„éŸ³é¢‘æ•°æ®ã€‚

#### 2.1.1 æŠ€æœ¯é€‰å‹

| æŠ€æœ¯ | ç”¨é€” | åŸå›  |
|------|------|------|
| NSCache | å†…å­˜ç¼“å­˜å­˜å‚¨ | è‡ªåŠ¨å¤„ç†å†…å­˜è­¦å‘Šï¼Œæ”¯æŒæˆæœ¬é™åˆ¶ |
| NSFileManager | ä¸´æ—¶æ–‡ä»¶ç®¡ç† | ç³»ç»Ÿçº§æ–‡ä»¶æ“ä½œï¼Œç¨³å®šå¯é  |
| NSURLSession | åå°ä¸‹è½½ | ç³»ç»ŸåŸç”Ÿï¼Œæ”¯æŒåå°ä»»åŠ¡ |
| dispatch_queue_t | å¹¶å‘æ§åˆ¶ | GCD å®ç°å¼‚æ­¥ä¸‹è½½ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ |

#### 2.1.2 æ ¸å¿ƒå‚æ•°é…ç½®

```objc
static const NSUInteger kMaxCacheCount = 10;          // æœ€å¤šç¼“å­˜ 10 é¦–æ­Œ
static const NSUInteger kMaxCacheSize = 100 * 1024 * 1024;  // æœ€å¤§ 100MB
static const NSUInteger kMaxSingleSongSize = 20 * 1024 * 1024;  // å•é¦–æœ€å¤§ 20MB
```

#### 2.1.3 ç¼“å­˜ç­–ç•¥

**NSCache é…ç½®ï¼š**
```objc
_audioCache.countLimit = kMaxCacheCount;        // æ•°é‡é™åˆ¶ï¼š10 é¦–
_audioCache.totalCostLimit = kMaxCacheSize;     // æˆæœ¬é™åˆ¶ï¼š100MB
```

**NSCache ç‰¹æ€§åˆ©ç”¨ï¼š**
- **è‡ªåŠ¨æ¸…ç†**ï¼šå½“å†…å­˜ç´§å¼ æ—¶ï¼ŒNSCache ä¼šè‡ªåŠ¨é‡Šæ”¾éå½“å‰æ’­æ”¾çš„æ­Œæ›²
- **æˆæœ¬è®¡ç®—**ï¼šä»¥æ•°æ®å¤§å°ï¼ˆå­—èŠ‚ï¼‰ä½œä¸ºæˆæœ¬ï¼Œä¼˜å…ˆä¿ç•™å°æ–‡ä»¶
- **çº¿ç¨‹å®‰å…¨**ï¼šNSCache æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ— éœ€é¢å¤–åŠ é”

#### 2.1.4 æ ¸å¿ƒæ–¹æ³•å®ç°

##### 1. æŸ¥è¯¢ç¼“å­˜ `isCached:`

```objc
- (BOOL)isCached:(NSString *)songId {
    if (!songId || songId.length == 0) return NO;
    
    // æŸ¥è¯¢ NSCache
    BOOL cached = [self.audioCache objectForKey:songId] != nil;
    if (cached) {
        // åˆ·æ–°ç¼“å­˜ä¿æŠ¤ï¼ˆé‡æ–°è®¾ç½®ï¼Œé˜²æ­¢è¢«æ¸…ç†ï¼‰
        NSData *data = [self.audioCache objectForKey:songId];
        [self.audioCache setObject:data forKey:songId cost:data.length];
    }
    return cached;
}
```

##### 2. å†™å…¥ç¼“å­˜ `cacheData:forSongId:`

```objc
- (void)cacheData:(NSData *)data forSongId:(NSString *)songId {
    if (!data || !songId || data.length == 0) return;
    
    // é™åˆ¶å•é¦–æ­Œæ›²å¤§å°ï¼ˆè¶…è¿‡ 20MB ä¸ç¼“å­˜ï¼‰
    if (data.length > kMaxSingleSongSize) {
        NSLog(@"âš ï¸ æ­Œæ›²å¤ªå¤§è·³è¿‡: %.2f MB > 20MB", data.length / 1024.0 / 1024.0);
        return;
    }
    
    // ä½¿ç”¨æˆæœ¬ï¼ˆæ•°æ®å¤§å°ï¼‰ä½œä¸ºç¼“å­˜æƒé‡
    NSUInteger cost = data.length;
    [self.audioCache setObject:data forKey:songId cost:cost];
}
```

##### 3. åå°ä¸‹è½½ `downloadAndCache:`

```objc
- (void)downloadAndCache:(XC_YYSongData *)song {
    // é˜²é‡å¤ä¸‹è½½æ£€æŸ¥
    @synchronized (self.downloadingSongs) {
        if ([self.downloadingSongs containsObject:songId]) {
            return;  // å·²åœ¨ä¸‹è½½ä¸­ï¼Œè·³è¿‡
        }
        [self.downloadingSongs addObject:songId];
    }
    
    // URL é¢„å¤„ç†
    NSString *trimmedUrl = [originalUrl stringByTrimmingCharactersInSet:[NSCharacterSet whitespaceAndNewlineCharacterSet]];
    NSString *encodedUrl = [trimmedUrl stringByAddingPercentEncodingWithAllowedCharacters:[NSCharacterSet URLQueryAllowedCharacterSet]];
    NSURL *url = [NSURL URLWithString:encodedUrl];
    
    // å¹¶å‘é˜Ÿåˆ—å¼‚æ­¥ä¸‹è½½
    dispatch_async(self.downloadQueue, ^{
        NSURLRequest *request = [NSURLRequest requestWithURL:url];
        NSURLSessionDataTask *task = [[NSURLSession sharedSession] 
            dataTaskWithRequest:request 
            completionHandler:^(NSData *data, NSURLResponse *response, NSError *error) {
                
                if (error) {
                    NSLog(@"âŒ ä¸‹è½½å¤±è´¥: %@", error.localizedDescription);
                    return;
                }
                
                // ä¸‹è½½æˆåŠŸï¼Œå†™å…¥å†…å­˜ç¼“å­˜
                if (data && data.length > 0) {
                    dispatch_async(dispatch_get_main_queue(), ^{
                        [self cacheData:data forSongId:songId];
                    });
                }
            }];
        [task resume];
    });
}
```

##### 4. æœ¬åœ°æ–‡ä»¶è½¬æ¢ `localURLForSongId:`

```objc
- (NSURL *)localURLForSongId:(NSString *)songId {
    NSData *data = [self dataForSongId:songId];
    if (!data) return nil;
    
    // ç”Ÿæˆä¸´æ—¶æ–‡ä»¶è·¯å¾„
    NSString *fileName = [NSString stringWithFormat:@"%@.mp3", songId];
    NSString *filePath = [self.tempDirectory stringByAppendingPathComponent:fileName];
    
    // å†™å…¥ä¸´æ—¶æ–‡ä»¶
    if ([data writeToFile:filePath atomically:YES]) {
        return [NSURL fileURLWithPath:filePath];  // è¿”å› file:// URL
    }
    return nil;
}
```

### 2.2 XCResourceLoaderManagerï¼ˆèµ„æºåŠ è½½æ‹¦æˆªå™¨ï¼‰

**åŸºäº AVAssetResourceLoaderDelegate**ï¼Œç”¨äºæ‹¦æˆª AVPlayer çš„ç½‘ç»œè¯·æ±‚ã€‚

#### 2.2.1 å·¥ä½œåŸç†

```objc
// 1. åˆ›å»ºè‡ªå®šä¹‰ Scheme çš„ URL
NSURL *customURL = [self customURLFromOriginalURL:originalURL];
// ç»“æœ: pyrotechnic://m7.music.126.net/xxx/xxx.mp3

// 2. åˆ›å»º AVPlayerItem æ—¶ä½¿ç”¨è‡ªå®šä¹‰ URL
AVPlayerItem *item = [AVPlayerItem playerItemWithURL:customURL];

// 3. è®¾ç½® ResourceLoader ä»£ç†
[item.resourceLoader setDelegate:[XCResourceLoaderManager sharedInstance] 
                           queue:dispatch_get_main_queue()];

// 4. æ‹¦æˆªåˆ°è¯·æ±‚åï¼Œä»ç¼“å­˜è¿”å›æ•°æ®æˆ–è½¬å‘åˆ°ç½‘ç»œ
- (BOOL)resourceLoader:(AVAssetResourceLoader *)resourceLoader 
shouldWaitForLoadingOfRequestedResource:(AVAssetResourceLoadingRequest *)loadingRequest {
    // æ‹¦æˆªé€»è¾‘ï¼šæ£€æŸ¥ç¼“å­˜ â†’ è¿”å›ç¼“å­˜æ•°æ® / è½¬å‘ç½‘ç»œè¯·æ±‚
    return YES;
}
```

#### 2.2.2 æ‹¦æˆªç¼“å­˜æµç¨‹

```
AVPlayer è¯·æ±‚æ’­æ”¾
    â”‚
    â–¼
ResourceLoader æ‹¦æˆªåˆ°è¯·æ±‚
    â”‚
    â–¼
æŸ¥è¯¢æœ¬åœ°ç¼“å­˜
    â”‚
    â”œâ”€ å‘½ä¸­ â”€â”€â†’ ç›´æ¥å¡«å…… response å’Œ data â”€â”€â†’ å®Œæˆè¯·æ±‚
    â”‚
    â””â”€ æœªå‘½ä¸­ â”€â”€â†’ å‘èµ·ç½‘ç»œè¯·æ±‚ â”€â”€â†’ è¾¹ä¸‹è¾¹æ’­ â”€â”€â†’ å­˜å…¥ç¼“å­˜
```

---

## ä¸‰ã€ç¼“å­˜ç­–ç•¥è¯¦è§£

### 3.1 å†…å­˜ç®¡ç†ç­–ç•¥

#### 3.1.1 è‡ªåŠ¨æ¸…ç†æœºåˆ¶

NSCache åœ¨ä»¥ä¸‹æƒ…å†µä¼šè‡ªåŠ¨æ¸…ç†ï¼š

1. **å†…å­˜è­¦å‘Šæ—¶**ï¼šç³»ç»Ÿå‘é€ `UIApplicationDidReceiveMemoryWarningNotification`
2. **è¶…å‡ºæˆæœ¬é™åˆ¶**ï¼šå½“æ€»æˆæœ¬è¶…è¿‡ 100MB æ—¶ï¼ŒæŒ‰ LRU ç­–ç•¥æ¸…ç†
3. **è¶…å‡ºæ•°é‡é™åˆ¶**ï¼šå½“ç¼“å­˜æ­Œæ›²æ•°è¶…è¿‡ 10 é¦–æ—¶ï¼Œæ¸…ç†æœ€ä¹…æœªä½¿ç”¨çš„

#### 3.1.2 å½“å‰æ’­æ”¾ä¿æŠ¤

```objc
- (void)setCurrentPlayingSong:(NSString *)songId {
    self.currentSongId = songId;
    
    // é‡æ–°è®¾ç½®ç¼“å­˜å¯¹è±¡ï¼Œåˆ·æ–°å…¶åœ¨ NSCache ä¸­çš„"æ–°é²œåº¦"
    NSData *data = [self.audioCache objectForKey:songId];
    if (data) {
        [self.audioCache setObject:data forKey:songId cost:data.length];
    }
}
```

**åŸç†**ï¼šNSCache çš„ LRUï¼ˆæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰ç®—æ³•ä¼šå°†åˆšè®¿é—®çš„å¯¹è±¡æ ‡è®°ä¸º"æ–°é²œ"ï¼Œé™ä½è¢«æ¸…ç†çš„æ¦‚ç‡ã€‚

### 3.2 é¢„åŠ è½½ç­–ç•¥

#### 3.2.1 ä¸‹ä¸€é¦–é¢„åŠ è½½

```objc
- (void)playNextSong {
    // ... åˆ‡æ¢æ­Œæ›²é€»è¾‘ ...
    
    // é¢„åŠ è½½ä¸‹ä¸‹é¦–
    NSInteger preloadIndex = (nextIndex + 1) % self.playerlist.count;
    XC_YYSongData *preloadSong = self.playerlist[preloadIndex];
    [[XCMusicMemoryCache sharedInstance] downloadAndCache:preloadSong];
}
```

#### 3.2.2 é¢„åŠ è½½æ—¶åº

```
å½“å‰æ’­æ”¾: æ­Œæ›² A (å·²ç¼“å­˜)
    â”‚
    â–¼
ç”¨æˆ·ç‚¹å‡»ä¸‹ä¸€é¦–
    â”‚
    â”œâ”€ ç«‹å³æ’­æ”¾æ­Œæ›² B (ä»ç½‘ç»œæˆ–ç¼“å­˜)
    â”‚
    â””â”€ åå°å¼€å§‹ä¸‹è½½æ­Œæ›² C (é¢„åŠ è½½)
```

### 3.3 å¹¶å‘æ§åˆ¶

#### 3.3.1 ä¸‹è½½é˜Ÿåˆ—é…ç½®

```objc
// å¹¶å‘é˜Ÿåˆ—ï¼Œæ”¯æŒåŒæ—¶ä¸‹è½½å¤šé¦–æ­Œæ›²
_downloadQueue = dispatch_queue_create("com.spotifyclone.cache.download", 
                                        DISPATCH_QUEUE_CONCURRENT);

// é˜²é‡å¤ä¸‹è½½é›†åˆï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰
NSMutableSet<NSString *> *downloadingSongs;

// ä½¿ç”¨ @synchronized ä¿è¯çº¿ç¨‹å®‰å…¨
@synchronized (self.downloadingSongs) {
    if ([self.downloadingSongs containsObject:songId]) {
        return;  // è·³è¿‡é‡å¤ä¸‹è½½
    }
    [self.downloadingSongs addObject:songId];
}
```

#### 3.3.2 å¹¶å‘ä¸‹è½½é™åˆ¶

| é™åˆ¶ç±»å‹ | å€¼ | è¯´æ˜ |
|---------|-----|------|
| æœ€å¤§å¹¶å‘ä¸‹è½½æ•° | æ— é™åˆ¶ | ä¾èµ–ç³»ç»Ÿ NSURLSession è°ƒåº¦ |
| å•é¦–æ­Œæ›²å¤§å°é™åˆ¶ | 20MB | è¶…è¿‡åˆ™ä¸ç¼“å­˜ |
| æ€»ç¼“å­˜å¤§å°é™åˆ¶ | 100MB | NSCache è‡ªåŠ¨ç®¡ç† |

---

## å››ã€æ•°æ®æµå›¾

### 4.1 æ’­æ”¾æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·ç‚¹å‡»æ’­æ”¾  â”‚â”€â”€â”€â”€â–¶â”‚  playMusicWithId â”‚â”€â”€â”€â”€â–¶â”‚  æŸ¥è¯¢å†…å­˜ç¼“å­˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                       â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ å‘½ä¸­                   â”‚                        â”‚ æœªå‘½ä¸­
                              â–¼                        â”‚                        â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚ localURLFor â”‚                 â”‚               â”‚ findUrlOfSong   â”‚
                       â”‚   SongId    â”‚                 â”‚               â”‚   (ç½‘ç»œè¯·æ±‚)     â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚                        â”‚                        â”‚
                              â–¼                        â”‚                        â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚ å†™å…¥ä¸´æ—¶æ–‡ä»¶ â”‚                 â”‚               â”‚  AVPlayer æ’­æ”¾   â”‚
                       â”‚  è¿”å›æ–‡ä»¶URL â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚   (è¾¹ä¸‹è¾¹æ’­)     â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                                  â”‚
                                                                                  â–¼
                                                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                                         â”‚ åå° downloadAnd â”‚
                                                                         â”‚    Cache         â”‚
                                                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 ç¼“å­˜å†™å…¥æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸‹è½½å®Œæˆå›è°ƒ    â”‚â”€â”€â”€â”€â–¶â”‚  ä¸»çº¿ç¨‹ dispatch â”‚â”€â”€â”€â”€â–¶â”‚  cacheData      â”‚
â”‚  (NSURLSession) â”‚     â”‚  async(main)    â”‚     â”‚  forSongId      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                         â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ å¤§å° < 20MB             â”‚                         â”‚ å¤§å° >= 20MB
                              â–¼                         â”‚                         â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚ NSCache     â”‚                  â”‚                  â”‚   è·³è¿‡       â”‚
                       â”‚ setObject   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚  (ä¸ç¼“å­˜)    â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äº”ã€å…³é”®è®¾è®¡å†³ç­–

### 5.1 ä¸ºä»€ä¹ˆä½¿ç”¨ NSCache è€Œä¸æ˜¯ NSDictionaryï¼Ÿ

| ç‰¹æ€§ | NSCache | NSDictionary |
|------|---------|--------------|
| è‡ªåŠ¨æ¸…ç† | âœ… æ”¯æŒ | âŒ ä¸æ”¯æŒ |
| çº¿ç¨‹å®‰å…¨ | âœ… åŸç”Ÿæ”¯æŒ | âŒ éœ€æ‰‹åŠ¨åŠ é” |
| æˆæœ¬é™åˆ¶ | âœ… æ”¯æŒ | âŒ ä¸æ”¯æŒ |
| å†…å­˜è­¦å‘Šå“åº” | âœ… è‡ªåŠ¨ | âŒ éœ€æ‰‹åŠ¨å®ç° |

### 5.2 ä¸ºä»€ä¹ˆä½¿ç”¨ä¸´æ—¶æ–‡ä»¶è€Œä¸æ˜¯æ°¸ä¹…å­˜å‚¨ï¼Ÿ

1. **ç®€åŒ–ç®¡ç†**ï¼šç³»ç»Ÿä¼šè‡ªåŠ¨æ¸…ç† `/tmp/` ç›®å½•ï¼Œæ— éœ€æ‹…å¿ƒç£ç›˜ç©ºé—´
2. **å†…å­˜ä¼˜å…ˆ**ï¼šéŸ³é¢‘æ–‡ä»¶è¾ƒå¤§ï¼Œç£ç›˜ç¼“å­˜æ„ä¹‰ä¸å¤§
3. **å¿«é€Ÿè®¿é—®**ï¼šå†…å­˜ â†’ ä¸´æ—¶æ–‡ä»¶ â†’ æ’­æ”¾ï¼Œè·¯å¾„çŸ­

### 5.3 ä¸ºä»€ä¹ˆé‡‡ç”¨"è¾¹ä¸‹è¾¹æ’­ + åå°ç¼“å­˜"ç­–ç•¥ï¼Ÿ

```
åœºæ™¯ï¼šç”¨æˆ·å¿«é€Ÿåˆ‡æ­Œï¼Œåªå¬æ¯é¦–æ­Œçš„å‰ 10 ç§’

ç­–ç•¥å¯¹æ¯”ï¼š
1. å…ˆä¸‹è½½å†æ’­æ”¾ï¼šæ¯æ¬¡åˆ‡æ­Œéƒ½è¦ç­‰å¾…ä¸‹è½½ï¼Œä½“éªŒå·®
2. è¾¹ä¸‹è¾¹æ’­ï¼šç«‹å³æ’­æ”¾ï¼Œåå°æ…¢æ…¢ä¸‹è½½ï¼Œä½“éªŒå¥½
3. åªç¼“å­˜å½“å‰ï¼šåˆ‡å›ä¸Šä¸€é¦–éœ€è¦é‡æ–°ä¸‹è½½ï¼Œæµªè´¹æµé‡
```

### 5.4 é¢„åŠ è½½ç­–ç•¥çš„æƒè¡¡

**åªé¢„åŠ è½½ä¸‹ä¸€é¦–ï¼ˆè€Œéå…¨éƒ¨ï¼‰ï¼š**

- âœ… èŠ‚çœå†…å­˜å’Œæµé‡
- âœ… ç”¨æˆ·å¯èƒ½ä¸ä¼šå¬å®Œæ•´ä¸ªæ’­æ”¾åˆ—è¡¨
- âœ… é¿å…åå°ä¸‹è½½è¿‡å¤šå ç”¨å¸¦å®½
- âŒ å¿«é€Ÿè¿ç»­åˆ‡æ­Œå¯èƒ½æ— æ³•å‘½ä¸­ç¼“å­˜

---

## å…­ã€ç›‘æ§ä¸è°ƒè¯•

### 6.1 æ—¥å¿—è¾“å‡º

æ‰€æœ‰ç¼“å­˜æ“ä½œéƒ½æœ‰è¯¦ç»†çš„æ—¥å¿—è¾“å‡ºï¼Œä¾¿äºè°ƒè¯•ï¼š

```
[MemoryCache] âœ… åˆå§‹åŒ–å®Œæˆ
[MemoryCache]    æœ€å¤§ç¼“å­˜æ•°é‡: 10 é¦–
[MemoryCache]    æœ€å¤§ç¼“å­˜å¤§å°: 100.0 MB

[MemoryCache] âŒ æœªå‘½ä¸­ç¼“å­˜: 2140776005
[MemoryCache] ğŸš€ å¼€å§‹ä¸‹è½½: 2140776005
[MemoryCache]    URL: http://m7.music.126.net/...

[MemoryCache] ğŸ“¥ ä¸‹è½½å®Œæˆ: 2140776005 (HTTP 200, å¤§å°: 3.45 MB)
[MemoryCache] âœ… å·²å†™å…¥ç¼“å­˜: 2140776005 (3.45 MB)

[MemoryCache] âœ… å‘½ä¸­ç¼“å­˜: 2140776005 (å¤§å°: 3.45 MB)
[MemoryCache] âœ… è¯»å–ç¼“å­˜æ•°æ®: 2140776005 (3.45 MB)
```

### 6.2 æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å®é™…å€¼ |
|------|--------|--------|
| ç¼“å­˜å‘½ä¸­ç‡ | > 50% | å¾…ç»Ÿè®¡ |
| å†…å­˜å ç”¨ | < 100MB | åŠ¨æ€ |
| ä¸‹è½½å¤±è´¥ç‡ | < 5% | å¾…ç»Ÿè®¡ |
| å¹³å‡åŠ è½½æ—¶é—´ | < 1s | å¾…ç»Ÿè®¡ |

---

## ä¸ƒã€å¾…ä¼˜åŒ–é¡¹

### 7.1 å·²çŸ¥é—®é¢˜

1. **URL åè®®æ‹¦æˆªå™¨æœªå®Œæˆ**ï¼š`XCResourceLoaderManager` ç›®å‰åªæ‰“å°æ—¥å¿—ï¼Œæœªå®ç°çœŸæ­£çš„ç¼“å­˜æ‹¦æˆª
2. **æ— æŒä¹…åŒ–ç¼“å­˜**ï¼šApp é‡å¯åç¼“å­˜ä¸¢å¤±
3. **æ— ç¼“å­˜æŒä¹…åŒ–ç»Ÿè®¡**ï¼šæ— æ³•åˆ†æç”¨æˆ·æ”¶å¬ä¹ æƒ¯ä¼˜åŒ–é¢„åŠ è½½

### 7.2 æœªæ¥ä¼˜åŒ–æ–¹å‘

1. **ç£ç›˜ç¼“å­˜**ï¼šä½¿ç”¨ WCDB å­˜å‚¨éŸ³é¢‘æ•°æ®ï¼Œæ”¯æŒç¦»çº¿æ’­æ”¾
2. **æ™ºèƒ½é¢„åŠ è½½**ï¼šæ ¹æ®ç”¨æˆ·æ”¶å¬ä¹ æƒ¯é¢„æµ‹ä¸‹ä¸€é¦–
3. **ç¼“å­˜å‹ç¼©**ï¼šå¯¹éŸ³é¢‘æ•°æ®è¿›è¡Œå‹ç¼©å­˜å‚¨
4. **åˆ†ç‰‡ç¼“å­˜**ï¼šæ”¯æŒ HTTP Range è¯·æ±‚ï¼Œå®ç°ç²¾å‡†ç¼“å­˜

---

## å…«ã€API ä½¿ç”¨ç¤ºä¾‹

### 8.1 åŸºç¡€ä½¿ç”¨

```objc
// 1. è·å–ç¼“å­˜å®ä¾‹
XCMusicMemoryCache *cache = [XCMusicMemoryCache sharedInstance];

// 2. æŸ¥è¯¢ç¼“å­˜
if ([cache isCached:@"song123"]) {
    NSData *data = [cache dataForSongId:@"song123"];
    // ä½¿ç”¨æ•°æ®...
}

// 3. å†™å…¥ç¼“å­˜
NSData *audioData = ...; // ä»ç½‘ç»œè·å–
[cache cacheData:audioData forSongId:@"song123"];

// 4. åå°ä¸‹è½½å¹¶ç¼“å­˜
XC_YYSongData *song = ...;
[cache downloadAndCache:song];

// 5. è·å–æœ¬åœ°æ–‡ä»¶ URLï¼ˆç”¨äº AVPlayerï¼‰
NSURL *localURL = [cache localURLForSongId:@"song123"];
AVPlayerItem *item = [AVPlayerItem playerItemWithURL:localURL];
```

### 8.2 ä¸æ’­æ”¾å™¨é›†æˆ

```objc
// åœ¨ XCMusicPlayerModel ä¸­ä½¿ç”¨
- (void)playMusicWithId:(NSString *)songId {
    // 1. å…ˆæŸ¥ç¼“å­˜
    NSURL *localURL = [[XCMusicMemoryCache sharedInstance] localURLForSongId:songId];
    if (localURL) {
        [self playWithURL:localURL songId:songId];
        return;
    }
    
    // 2. æ— ç¼“å­˜ï¼Œç½‘ç»œè·å–
    [[XCNetworkManager sharedInstance] findUrlOfSongWithId:songId 
                                                completion:^(NSURL *songUrl) {
        [self playWithURL:songUrl songId:songId];
        
        // 3. åå°ç¼“å­˜
        XC_YYSongData *song = ...;
        song.songUrl = songUrl.absoluteString;
        [[XCMusicMemoryCache sharedInstance] downloadAndCache:song];
    }];
}
```

---

## ä¹ã€æ€»ç»“

æœ¬ç¼“å­˜æœºåˆ¶é‡‡ç”¨**å†…å­˜ç¼“å­˜ä¸ºä¸»ã€ä¸´æ—¶æ–‡ä»¶ä¸ºè¾…**çš„ä¸¤çº§æ¶æ„ï¼š

1. **NSCache** æä¾›é«˜æ€§èƒ½çš„å†…å­˜ç¼“å­˜ï¼Œè‡ªåŠ¨ç®¡ç†å†…å­˜å‹åŠ›
2. **ä¸´æ—¶æ–‡ä»¶** æä¾› AVPlayer æ‰€éœ€çš„æ–‡ä»¶ URL æ”¯æŒ
3. **åå°ä¸‹è½½** å®ç°"è¾¹ä¸‹è¾¹æ’­"ï¼Œå¹³è¡¡å³æ—¶ä½“éªŒå’Œæµé‡èŠ‚çœ
4. **é¢„åŠ è½½ç­–ç•¥** æå‰å‡†å¤‡ä¸‹ä¸€é¦–ï¼Œæå‡è¿ç»­æ’­æ”¾ä½“éªŒ

æ•´ä½“è®¾è®¡éµå¾ª**ç®€å•ã€é«˜æ•ˆã€å¯æ‰©å±•**çš„åŸåˆ™ï¼Œä¸ºéŸ³ä¹æ’­æ”¾å™¨æä¾›äº†å¯é çš„æ•°æ®ç¼“å­˜æ”¯æŒã€‚
