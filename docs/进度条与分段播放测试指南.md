# 进度条与分段播放测试指南

> 文档版本: 1.0  
> 创建日期: 2026-02-20  
> 适用版本: Phase A + Phase B 完成后

---

## 一、测试前准备

### 1.1 检查代码编译

```bash
# 在 Xcode 中编译项目，确保无错误
cd "Spotify - clone"
open "Spotify - clone.xcworkspace"
```

### 1.2 准备测试环境

| 环境 | 要求 |
|------|------|
| 设备 | iPhone 真机或模拟器 |
| iOS 版本 | 26.0+ |
| 网络 | 可选（测试缓存时断网） |

### 1.3 查看日志

在 Xcode 中打开 Console，过滤关键字：
- `[MusicPlayerVC]` - 播放器视图控制器日志
- `[PlayerModel]` - 播放器模型日志
- `[ResourceLoader]` - 资源加载器日志

---

## 二、Phase A: 进度条拖动测试

### 2.1 基础功能测试

#### 测试 1: 触摸暂停
**步骤**:
1. 播放一首歌曲
2. 观察日志确认正在播放
3. 手指触摸进度条滑块

**预期结果**:
```
[MusicPlayerVC] 👇 用户开始拖动进度条
[MusicPlayerVC] 拖动前正在播放，先暂停
[PlayerModel] 暂停播放
[MusicPlayerVC] 停止进度条定时器
```
4. 音乐暂停，专辑封面缩小

#### 测试 2: 拖动跳转
**步骤**:
1. 触摸并拖动进度条到中间位置
2. 松开手指

**预期结果**:
```
[MusicPlayerVC] 🎚️ 拖动中: 01:45 (105.0s)  // 显示时间变化
[MusicPlayerVC] 👆 用户松开进度条
[MusicPlayerVC] 准备跳转到: 105.0s
[PlayerVC] ✅ 跳转完成: 105.0s
[MusicPlayerVC] 恢复播放
[PlayerModel] 继续播放
[MusicPlayerVC] 启动进度条定时器
```
5. 音乐从 105 秒处继续播放

#### 测试 3: 暂停状态下拖动
**步骤**:
1. 播放歌曲后暂停
2. 拖动进度条到任意位置
3. 松开

**预期结果**:
- 跳转完成
- 音乐**不自动恢复播放**（因为拖动前是暂停状态）
- 需要手动点击播放按钮继续

### 2.2 边界测试

#### 测试 4: 快速多次拖动
**步骤**:
1. 快速连续拖动进度条多次

**预期结果**:
```
[MusicPlayerVC] 检测到正在拖动中，重置状态
```
- 无崩溃，状态正确

#### 测试 5: 拖动到开始/结束
**步骤**:
1. 拖动到进度条最左边（0%）
2. 拖动到进度条最右边（100%）

**预期结果**:
- 0%: 跳转到 0 秒
- 100%: 跳转到歌曲总时长（可能触发播放完成）

### 2.3 锁屏测试

#### 测试 6: 锁屏进度控制
**步骤**:
1. 播放歌曲
2. 锁屏
3. 在锁屏界面显示播放器
4. 拖动进度条

**预期结果**:
```
[PlayerModel] 🎛️ 锁屏进度调整: 68.5s
[PlayerModel] 暂停播放
[PlayerModel] ✅ 锁屏跳转完成
[PlayerModel] 继续播放
```
5. 解锁后 App 内进度条位置同步

---

## 三、Phase B: 分段播放测试

### 3.1 L1 缓存测试

#### 测试 7: 首次播放（L1 未命中）
**步骤**:
1. 清除缓存（删除 App 重装或调用 clearAllCache）
2. 播放一首新歌
3. 观察日志

**预期结果**:
```
[ResourceLoader] 拦截请求: streaming://songId?url=...
[ResourceLoader] songId: xxx, 原始URL: http://...
[ResourceLoader] 请求范围: {0, 4294967295}, 长度: 4294967295
[ResourceLoader] ⬇️ 缓存未命中，开始网络请求
[ResourceLoader] ⬇️ 网络请求 Range: bytes=0-
[ResourceLoader] ✅ 网络请求成功，数据大小: 5242880
[ResourceLoader] 💾 数据已写入 L1 缓存，分段数: 10
[ResourceLoader] ✅ 响应播放器完成
```

#### 测试 8: 重复播放（L1 命中）
**步骤**:
1. 播放完一首歌（或拖动到不同位置）
2. 重新播放同一首歌

**预期结果**:
```
[ResourceLoader] 拦截请求: streaming://songId?url=...
[ResourceLoader] ✅ L1 缓存命中，大小: 5242880
[ResourceLoader] ✅ 响应完成，数据大小: 5242880
```
- 无网络请求，直接返回缓存数据
- 播放秒开

### 3.2 分段缓存测试

#### 测试 9: 拖动到未缓存位置
**步骤**:
1. 播放新歌（此时只有部分数据在 L1）
2. 拖动进度条到歌曲后半段

**预期结果**:
```
[MusicPlayerVC] 准备跳转到: 180.0s  // 拖动到后半段
[ResourceLoader] 拦截请求: streaming://...
[ResourceLoader] 请求范围: {2880000, 4194304}, 长度: 4194304
[ResourceLoader] ⬇️ 缓存未命中，开始网络请求
[ResourceLoader] ⬇️ 网络请求 Range: bytes=2880000-7074304
```
- 发起新的 Range 请求
- 数据写入 L1 新分段

#### 测试 10: 分段组装验证
**步骤**:
1. 播放一首歌，记录 L1 写入的分段
2. 拖动到之前播放过的位置

**预期结果**:
```
[ResourceLoader] 请求范围: {0, 524288}, 长度: 524288
[ResourceLoader] ✅ L1 缓存命中，大小: 524288
```
- 无需网络请求，直接从 L1 组装数据返回

### 3.3 L3 缓存测试

#### 测试 11: 切歌后 L3 命中
**步骤**:
1. 完整播放一首歌（让缓存进入 L3）
2. 切到下一首，再切回来

**预期结果**:
```
[PlayerModel] 保存当前歌曲到缓存: songId1
[PlayerModel] 当前歌曲缓存状态: L3(Complete)
...
[PlayerModel] 请求播放歌曲: songId1
[PlayerModel] ✅ 命中 L3 缓存，使用本地播放
[ResourceLoader] ✅ L3 完整缓存命中
```
- 直接播放本地文件，无需网络

### 3.4 网络异常测试

#### 测试 12: 断网播放缓存歌曲
**步骤**:
1. 播放一首歌，确保有 L3 缓存
2. 关闭网络（飞行模式）
3. 重新播放该歌曲

**预期结果**:
```
[PlayerModel] ✅ 命中 L3 缓存，使用本地播放
```
- 正常播放，无网络请求

#### 测试 13: 断网播放未缓存歌曲
**步骤**:
1. 清除所有缓存
2. 关闭网络
3. 尝试播放新歌

**预期结果**:
```
[ResourceLoader] ⬇️ 缓存未命中，开始网络请求
[ResourceLoader] ❌ 网络请求失败: ...
```
- 播放失败（预期行为）

---

## 四、综合场景测试

### 测试 14: 边下边播 + 拖动
**步骤**:
1. 播放新歌（开始下载）
2. 不等下载完，拖动到中间位置
3. 再拖动到开头

**预期结果**:
- 每次拖动都正确响应
- 数据逐步写入 L1
- 已缓存的部分无需重新下载

### 测试 15: 快速切歌
**步骤**:
1. 播放歌曲 A
2. 1 秒内快速切到歌曲 B，再切到歌曲 C

**预期结果**:
```
[PlayerModel] 保存当前歌曲到缓存: songA
[PlayerModel] 保存当前歌曲到缓存: songB
```
- 无崩溃
- 缓存正确保存

### 测试 16: 内存警告
**步骤**:
1. 播放多首歌曲，让 L1 缓存满
2. 模拟内存警告（真机可用，模拟器在 Device > Simulate Memory Warning）

**预期结果**:
```
[MemoryCache] Received memory warning, trimming cache...
[MemoryCache] Trimmed cache, freed: xxx bytes
```
- L1 非优先歌曲分段被清理
- 当前播放歌曲分段保留
- 播放不受影响

---

## 五、性能测试

### 5.1 加载速度对比

| 场景 | 预期耗时 | 测试方法 |
|------|----------|----------|
| L3 缓存播放 | < 100ms | 切歌到已缓存歌曲 |
| L1 缓存播放 | < 50ms | 拖动到已缓存位置 |
| 网络 Range 请求 | 取决于网速 | 拖动到未缓存位置 |

### 5.2 内存占用

**测试方法**: Xcode Debug Navigator > Memory

| 场景 | 预期内存 | 说明 |
|------|----------|------|
| 播放中 | +5~10MB | AVPlayer 正常占用 |
| L1 缓存满 | +100MB | 达到上限后稳定 |
| 内存警告后 | < 50MB | 非优先缓存被清理 |

---

## 六、常见问题排查

### 问题 1: 进度条不随播放移动
**检查**:
```
# 应该看到
[MusicPlayerVC] 启动进度条定时器
[MusicPlayerVC] 🎚️ 拖动中: ...  # 每0.5秒更新
```
**解决**: 检查 `startProgressTimer` 是否在播放时调用

### 问题 2: 拖动后播放失败
**检查**:
```
[ResourceLoader] 拦截请求: ...
[ResourceLoader] ❌ 网络请求失败
```
**解决**: 检查网络连接，或查看 L1/L3 是否命中

### 问题 3: 缓存未生效
**检查**:
- L1 是否存储成功：`[MemoryCache] Stored segment ...`
- 切歌时是否保存：`[PlayerModel] 保存当前歌曲到缓存`

### 问题 4: 锁屏无法控制进度
**检查**:
- `setupRemoteCommands` 是否被调用
- `changePlaybackPositionCommand` 是否有 target

---

## 七、测试检查清单

### Phase A 检查项
- [ ] 触摸滑块暂停
- [ ] 拖动显示时间
- [ ] 松开跳转
- [ ] 恢复播放
- [ ] 滑块自动更新
- [ ] 锁屏进度控制

### Phase B 检查项
- [ ] 首次播放网络请求
- [ ] 数据写入 L1
- [ ] 重复播放 L1 命中
- [ ] 拖动到未缓存位置 Range 请求
- [ ] 切歌保存到 L2/L3
- [ ] L3 命中直接播放
- [ ] 断网播放缓存歌曲

---

## 八、测试记录模板

```
测试日期: _______
测试设备: _______
iOS 版本: _______

测试项目: _______
测试结果: 通过 / 失败

日志关键信息:
_________________

问题描述:
_________________

截图/录屏:
_________________
```

---

**祝测试顺利！**
