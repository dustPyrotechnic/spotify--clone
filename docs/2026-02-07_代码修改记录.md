# 2026-02-07 代码修改记录

> 修改日期：2026-02-07  
> 修改人：AI Assistant  
> 修改目的：完善播放器 UI 数据绑定，解决锁屏进度显示问题

---

## 一、XC-YYSongData 数据结构扩展

### 修改文件
- `Spotify - clone/数据结构/XC-YYSongData.h`
- `Spotify - clone/数据结构/XC-YYSongData.mm`

### 新增属性（共 10 个）

| 属性名 | 类型 | JSON 映射 | 说明 |
|--------|------|-----------|------|
| `artist` | NSString | `ar[0].name` | 主艺术家名称 |
| `artistId` | NSString | `ar[0].id` | 主艺术家ID |
| `artists` | NSArray | `ar` | 完整艺术家数组 |
| `albumName` | NSString | `al.name` | 专辑名称 |
| `albumId` | NSString | `al.id` | 专辑ID |
| `duration` | NSInteger | `dt` | 时长（毫秒） |
| `mvId` | NSInteger | `mv` | MV ID（0表示无） |
| `trackNumber` | NSInteger | `no` | 专辑内序号 |
| `alias` | NSArray | `alia` | 别名数组 |
| `popularity` | NSInteger | `pop` | 热度值 0-100 |
| `fee` | NSInteger | `fee` | 付费类型 |

### 新增计算属性

| 属性名 | 类型 | 说明 |
|--------|------|------|
| `durationText` | NSString (readonly) | 格式化时长，如 "03:46" |
| `hasMV` | BOOL (readonly) | 是否有MV |
| `feeDescription` | NSString (readonly) | 付费类型描述 |

### YYModel 映射配置

```objc
+ (NSDictionary<NSString *, id> *)modelCustomPropertyMapper {
    return @{
        @"songId": @[@"id", @"albumId"],
        @"mainIma": @[@"al.picUrl", @"coverUrl"],
        @"albumName": @"al.name",
        @"albumId": @"al.id",
        @"duration": @"dt",
        @"mvId": @"mv",
        @"trackNumber": @"no",
        @"popularity": @"pop",
        @"alias": @"alia",
        @"fee": @"fee"
    };
}
```

### 自定义转换处理

在 `modelCustomTransformFromDictionary:` 中处理 `ar` 数组：
- 提取第一个艺术家作为主艺术家
- 如果数组为空，设置默认值为 "未知艺术家"
- 如果专辑名为空，设置默认值为 "未知专辑"

### durationText 实现

```objc
- (NSString *)durationText {
    if (self.duration <= 0) {
        return @"00:00";
    }
    NSInteger totalSeconds = self.duration / 1000;
    NSInteger minutes = totalSeconds / 60;
    NSInteger seconds = totalSeconds % 60;
    return [NSString stringWithFormat:@"%02ld:%02ld", (long)minutes, (long)seconds];
}
```

---

## 二、专辑详情页 Cell 修改

### 修改文件
- `Spotify - clone/详细页面/cell/XCAlbumDetailCell.h`
- `Spotify - clone/详细页面/cell/XCAlbumDetailCell.m`

### 新增属性

```objc
/// 显示歌曲时长
@property (nonatomic, strong) UILabel *durationLabel;
```

### 样式设置

```objc
self.durationLabel.font = [UIFont systemFontOfSize:12.0 weight:UIFontWeightRegular];
self.durationLabel.textColor = [UIColor tertiaryLabelColor];
self.durationLabel.textAlignment = NSTextAlignmentRight;
```

### 布局约束

```objc
[self.durationLabel mas_makeConstraints:^(MASConstraintMaker *make) {
    make.centerY.equalTo(self.contentView);
    make.right.equalTo(self.menuButton.mas_left).offset(-8);
    make.width.mas_greaterThanOrEqualTo(30);
}];
```

---

## 三、专辑详情页数据绑定

### 修改文件
- `Spotify - clone/详细页面/XCALbumDetailViewController.m`

### 修改内容

**1. 替换硬编码歌手名**

修改前：
```objc
cell.authorLabel.text = @"赵本山";
```

修改后：
```objc
cell.authorLabel.text = song.artist;
```

**2. 添加时长显示**

```objc
cell.durationLabel.text = song.durationText;
```

---

## 四、锁屏信息显示优化

### 修改文件
- `Spotify - clone/5. TabBar附加视图，搜索部分/1. 音乐播放器/音乐播放详细页面/XCMusicPlayerModel.h`
- `Spotify - clone/5. TabBar附加视图，搜索部分/1. 音乐播放器/音乐播放详细页面/XCMusicPlayerModel.m`

### 新增方法声明（.h）

```objc
#pragma mark - 锁屏信息更新
- (void)updateLockScreenInfo;
- (void)startLockScreenProgressTimer;
- (void)stopLockScreenProgressTimer;
```

### 新增定时器属性（.m）

```objc
@interface XCMusicPlayerModel ()
@property (nonatomic, strong) NSTimer *lockScreenTimer;
@end
```

### 修改锁屏信息更新方法

**歌手和专辑名**

修改前：
```objc
[dict setObject:@"测试歌手 - Ed Sheeran" forKey:MPMediaItemPropertyArtist];
[dict setObject:@"测试专辑 - Divide" forKey:MPMediaItemPropertyAlbumTitle];
```

修改后：
```objc
[dict setObject:(self.nowPlayingSong.artist ?: @"未知艺术家") forKey:MPMediaItemPropertyArtist];
[dict setObject:(self.nowPlayingSong.albumName ?: @"未知专辑") forKey:MPMediaItemPropertyAlbumTitle];
```

**已播放时间**

修改前（固定值）：
```objc
[dict setObject:@(50.0) forKey:MPNowPlayingInfoPropertyElapsedPlaybackTime];
```

修改后（实际值）：
```objc
NSTimeInterval currentTime = 0;
if (self.player) {
    currentTime = CMTimeGetSeconds(self.player.currentTime);
    if (isnan(currentTime) || currentTime < 0) {
        currentTime = 0;
    }
}
[dict setObject:@(currentTime) forKey:MPNowPlayingInfoPropertyElapsedPlaybackTime];
```

### 新增定时器管理方法

**启动定时器**

```objc
- (void)startLockScreenProgressTimer {
    [self stopLockScreenProgressTimer];
    self.lockScreenTimer = [NSTimer scheduledTimerWithTimeInterval:1.0
                                                            target:self
                                                          selector:@selector(updateLockScreenProgress)
                                                          userInfo:nil
                                                           repeats:YES];
}
```

**停止定时器**

```objc
- (void)stopLockScreenProgressTimer {
    if (self.lockScreenTimer) {
        [self.lockScreenTimer invalidate];
        self.lockScreenTimer = nil;
    }
}
```

**定时更新锁屏进度**

```objc
- (void)updateLockScreenProgress {
    if (!self.nowPlayingSong || !self.player) {
        return;
    }
    
    MPNowPlayingInfoCenter *infoCenter = [MPNowPlayingInfoCenter defaultCenter];
    NSMutableDictionary *dict = [NSMutableDictionary dictionaryWithDictionary:infoCenter.nowPlayingInfo];
    
    NSTimeInterval currentTime = CMTimeGetSeconds(self.player.currentTime);
    if (isnan(currentTime) || currentTime < 0) {
        currentTime = 0;
    }
    
    [dict setObject:@(currentTime) forKey:MPNowPlayingInfoPropertyElapsedPlaybackTime];
    
    CGFloat rate = (self.player.rate > 0) ? 1.0 : 0.0;
    [dict setObject:@(rate) forKey:MPNowPlayingInfoPropertyPlaybackRate];
    
    [infoCenter setNowPlayingInfo:dict];
}
```

### 修改播放控制方法

**playMusic（继续播放）**

```objc
- (void)playMusic {
    NSLog(@"[PlayerModel] ▶️ 继续播放");
    [self.player play];
    [self startLockScreenProgressTimer];  // 新增
    [self updateLockScreenInfo];           // 新增
}
```

**pauseMusic（暂停）**

```objc
- (void)pauseMusic {
    NSLog(@"[PlayerModel] ⏸️ 暂停播放");
    [self.player pause];
    [self stopLockScreenProgressTimer];   // 新增
    [self updateLockScreenInfo];           // 新增
}
```

**playWithURL（开始播放新歌曲）**

```objc
- (void)playWithURL:(NSURL *)url songId:(NSString *)songId {
    // ... 原有代码 ...
    [self.player play];
    [self updateLockScreenInfo];
    [self startLockScreenProgressTimer];   // 新增
}
```

---

## 五、修改效果

### 专辑详情页
- ✅ 歌手名从 "赵本山" 改为实际歌手名
- ✅ 新增时长显示，格式为 "03:46"

### 锁屏显示
- ✅ 歌手名显示为实际值（如 "周深"）
- ✅ 专辑名显示为实际值（如 "反深代词"）
- ✅ 总时长使用歌曲实际时长
- ✅ 已播放时间实时更新（每秒刷新）
- ✅ 暂停时进度条停止走动

---

## 六、涉及文件汇总

| 文件路径 | 修改类型 | 说明 |
|----------|----------|------|
| `数据结构/XC-YYSongData.h` | 修改 | 新增 10+ 个属性 |
| `数据结构/XC-YYSongData.mm` | 修改 | YYModel 映射 + 计算属性 |
| `详细页面/cell/XCAlbumDetailCell.h` | 修改 | 新增 durationLabel 属性 |
| `详细页面/cell/XCAlbumDetailCell.m` | 修改 | 添加时长标签布局和初始化 |
| `详细页面/XCALbumDetailViewController.m` | 修改 | 替换硬编码，添加时长绑定 |
| `5. TabBar.../XCMusicPlayerModel.h` | 修改 | 新增锁屏方法声明 |
| `5. TabBar.../XCMusicPlayerModel.m` | 修改 | 锁屏逻辑 + 定时器管理 |

---

## 七、测试验证清单

- [ ] 专辑详情页显示正确歌手名
- [ ] 专辑详情页显示正确时长
- [ ] 锁屏显示正确歌手名
- [ ] 锁屏显示正确专辑名
- [ ] 锁屏总时长正确
- [ ] 锁屏进度随播放更新
- [ ] 暂停时锁屏进度停止
- [ ] 恢复播放时锁屏进度继续
